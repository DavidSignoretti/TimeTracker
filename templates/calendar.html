{% extends "layout.html" %}

{% block title %}Calendar - Time Tracker{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h1>Calendar</h1>
    <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addEventModal">
        <i class="fas fa-plus"></i> Add Event
    </button>
</div>

<div class="card bg-dark text-white border-secondary">
    <div class="card-body">
        <div id="calendar"></div>
    </div>
</div>

<!-- Add Event Modal -->
<div class="modal fade" id="addEventModal" tabindex="-1" aria-labelledby="addEventModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content bg-dark text-white border-secondary">
            <form action="{{ url_for('add_calendar_event') }}" method="POST">
                <div class="modal-header border-secondary">
                    <h5 class="modal-title" id="addEventModalLabel">Add Calendar Event</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="title" class="form-label">Title</label>
                        <input type="text" class="form-control bg-secondary text-white border-0" id="title" name="title" required>
                    </div>
                    <div class="mb-3">
                        <label for="location" class="form-label">Location</label>
                        <input type="text" class="form-control bg-secondary text-white border-0" id="location" name="location">
                    </div>
                    <div class="mb-3 form-check">
                        <input type="checkbox" class="form-check-input" id="all_day" name="all_day">
                        <label class="form-check-label" for="all_day">All Day</label>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="start_time" class="form-label">Start Time</label>
                            <input type="datetime-local" class="form-control bg-secondary text-white border-0" id="start_time" name="start_time" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="end_time" class="form-label">End Time</label>
                            <input type="datetime-local" class="form-control bg-secondary text-white border-0" id="end_time" name="end_time" required>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="client_id" class="form-label">Client</label>
                        <select class="form-select bg-secondary text-white border-0" id="client_id" name="client_id" required>
                            <option value="">Select Client</option>
                            {% for client in clients %}
                            <option value="{{ client.id }}">{{ client.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="task_id" class="form-label">Task (Optional)</label>
                        <select class="form-select bg-secondary text-white border-0" id="task_id" name="task_id">
                            <option value="">None</option>
                            {% for task in tasks %}
                            <option value="{{ task.id }}" data-client-id="{{ task.client_id }}">{{ task.title }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="mb-3 form-check">
                        <input type="checkbox" class="form-check-input" id="is_billable" name="is_billable">
                        <label class="form-check-label" for="is_billable">Billable (Create Time Entry)</label>
                    </div>
                </div>
                <div class="modal-footer border-secondary">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save Event</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Edit Event Modal -->
<div class="modal fade" id="editEventModal" tabindex="-1" aria-labelledby="editEventModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content bg-dark text-white border-secondary">
            <form id="editEventForm" method="POST">
                <div class="modal-header border-secondary">
                    <h5 class="modal-title" id="editEventModalLabel">Edit Calendar Event</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="edit_title" class="form-label">Title</label>
                        <input type="text" class="form-control bg-secondary text-white border-0" id="edit_title" name="title" required>
                    </div>
                    <div class="mb-3">
                        <label for="edit_location" class="form-label">Location</label>
                        <input type="text" class="form-control bg-secondary text-white border-0" id="edit_location" name="location">
                    </div>
                    <div class="mb-3 form-check">
                        <input type="checkbox" class="form-check-input" id="edit_all_day" name="all_day">
                        <label class="form-check-label" for="edit_all_day">All Day</label>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="edit_start_time" class="form-label">Start Time</label>
                            <input type="datetime-local" class="form-control bg-secondary text-white border-0" id="edit_start_time" name="start_time" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="edit_end_time" class="form-label">End Time</label>
                            <input type="datetime-local" class="form-control bg-secondary text-white border-0" id="edit_end_time" name="end_time" required>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="edit_client_id" class="form-label">Client</label>
                        <select class="form-select bg-secondary text-white border-0" id="edit_client_id" name="client_id" required>
                            <option value="">Select Client</option>
                            {% for client in clients %}
                            <option value="{{ client.id }}">{{ client.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="edit_task_id" class="form-label">Task (Optional)</label>
                        <select class="form-select bg-secondary text-white border-0" id="edit_task_id" name="task_id">
                            <option value="">None</option>
                            {% for task in tasks %}
                            <option value="{{ task.id }}" data-client-id="{{ task.client_id }}">{{ task.title }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="mb-3 form-check">
                        <input type="checkbox" class="form-check-input" id="edit_is_billable" name="is_billable">
                        <label class="form-check-label" for="edit_is_billable">Billable (Create Time Entry)</label>
                        <small class="text-muted d-block">If already billable, checking this again will not create a duplicate entry.</small>
                    </div>
                    <div id="task_button_container" class="mt-3 d-none">
                        <a id="open_task_btn" href="#" class="btn btn-info btn-sm">
                            <i class="fas fa-external-link-alt"></i> Open Task
                        </a>
                    </div>
                </div>
                <div class="modal-footer border-secondary d-flex justify-content-between">
                    <button type="submit" form="deleteEventForm" class="btn btn-danger" onclick="return confirm('Are you sure you want to delete this event?')">Delete</button>
                    <div>
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-primary">Save Changes</button>
                    </div>
                </div>
            </form>
            <form id="deleteEventForm" method="POST"></form>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/index.global.min.js'></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    var calendarEl = document.getElementById('calendar');
    var calendar = new FullCalendar.Calendar(calendarEl, {
        initialView: 'dayGridMonth',
        headerToolbar: {
            left: 'prev,next today',
            center: 'title',
            right: 'dayGridMonth,timeGridWeek,timeGridDay'
        },
        themeSystem: 'bootstrap5',
        events: '/api/calendar-events',
        selectable: true,
        editable: true,
        eventClick: function(info) {
            var event = info.event;
            var props = event.extendedProps;
            
            document.getElementById('edit_title').value = event.title;
            document.getElementById('edit_location').value = props.location || '';
            document.getElementById('edit_all_day').checked = event.allDay;
            
            // Format dates for datetime-local input (YYYY-MM-DDTHH:MM)
            var start = event.start;
            var end = event.end || event.start;
            
            var formatDateTime = function(date) {
                var d = new Date(date);
                var pad = (n) => n.toString().padStart(2, '0');
                return d.getFullYear() + '-' + pad(d.getMonth() + 1) + '-' + pad(d.getDate()) + 
                       'T' + pad(d.getHours()) + ':' + pad(d.getMinutes());
            };
            
            document.getElementById('edit_start_time').value = formatDateTime(start);
            document.getElementById('edit_end_time').value = formatDateTime(end);
            document.getElementById('edit_client_id').value = props.client_id;
            document.getElementById('edit_task_id').value = props.task_id || '';
            document.getElementById('edit_is_billable').checked = props.is_billable;
            
            if (props.task_id) {
                document.getElementById('task_button_container').classList.remove('d-none');
                document.getElementById('open_task_btn').href = '/tasks/' + props.task_id + '/edit';
            } else {
                document.getElementById('task_button_container').classList.add('d-none');
            }
            
            document.getElementById('editEventForm').action = '/calendar/edit/' + event.id;
            document.getElementById('deleteEventForm').action = '/calendar/delete/' + event.id;
            
            var modal = new bootstrap.Modal(document.getElementById('editEventModal'));
            modal.show();
        },
        select: function(info) {
            document.getElementById('start_time').value = info.startStr.substring(0, 16);
            var endStr = info.endStr;
            if (info.allDay) {
                document.getElementById('end_time').value = info.startStr.substring(0, 10) + 'T23:59';
                document.getElementById('all_day').checked = true;
            } else {
                document.getElementById('end_time').value = info.endStr.substring(0, 16);
                document.getElementById('all_day').checked = false;
            }
            
            var modal = new bootstrap.Modal(document.getElementById('addEventModal'));
            modal.show();
        }
    });
    calendar.render();

    // Prefill logic if redirected from task
    const urlParams = new URLSearchParams(window.location.search);
    const prefillTaskId = urlParams.get('prefill_task_id');
    if (prefillTaskId) {
        document.getElementById('task_id').value = prefillTaskId;
        const taskOption = document.querySelector(`#task_id option[value="${prefillTaskId}"]`);
        if (taskOption) {
            const clientId = taskOption.getAttribute('data-client-id');
            document.getElementById('client_id').value = clientId;
            document.getElementById('title').value = "Task: " + taskOption.text;
        }
        
        var now = new Date();
        var later = new Date(now.getTime() + 60 * 60 * 1000);
        var pad = (n) => n.toString().padStart(2, '0');
        var format = (d) => d.getFullYear() + '-' + pad(d.getMonth() + 1) + '-' + pad(d.getDate()) + 
                       'T' + pad(d.getHours()) + ':' + pad(d.getMinutes());
        
        document.getElementById('start_time').value = format(now);
        document.getElementById('end_time').value = format(later);

        var modal = new bootstrap.Modal(document.getElementById('addEventModal'));
        modal.show();
    }
    
    document.getElementById('task_id').addEventListener('change', function() {
        const selectedOption = this.options[this.selectedIndex];
        const clientId = selectedOption.getAttribute('data-client-id');
        if (clientId) {
            document.getElementById('client_id').value = clientId;
        }
    });
    
    document.getElementById('edit_task_id').addEventListener('change', function() {
        const selectedOption = this.options[this.selectedIndex];
        const clientId = selectedOption.getAttribute('data-client-id');
        if (clientId) {
            document.getElementById('edit_client_id').value = clientId;
        }
    });
});
</script>
<style>
    .fc {
        max-height: 800px;
    }
    .fc-event {
        cursor: pointer;
    }
    .fc-theme-bootstrap5 a {
        color: white;
        text-decoration: none;
    }
</style>
{% endblock %}
